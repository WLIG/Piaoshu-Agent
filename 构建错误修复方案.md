# 构建错误修复方案

## 问题诊断

### 发现的问题
1. **预渲染错误**: `/test-api` 页面在构建时预渲染失败
2. **Next.js 安装损坏**: 缺少模块 `../shared/lib/errors/canary-only-config-error`

### 根本原因
Next.js 的 node_modules 安装不完整或损坏，导致构建命令无法正常运行。

## 已完成的修复

### 1. 配置修复
✅ 更新了 `next.config.ts`，添加了：
- `eslint.ignoreDuringBuilds: true`
- `experimental.serverActions.bodySizeLimit: '10mb'`

### 2. 页面修复
✅ 为所有测试页面添加了 `export const dynamic = 'force-dynamic'`：
- `src/app/test-api/page.tsx`
- `src/app/media-test/page.tsx`
- `src/app/chat-test/page.tsx`
- `src/app/demo/page.tsx`
- `src/app/simple/page.tsx`
- `src/app/complete/page.tsx`

这可以防止 Next.js 尝试静态生成这些动态页面。

## 需要执行的修复步骤

### 方案 1: 完全重新安装（推荐）

```bash
# 1. 删除 node_modules 和 lock 文件
rmdir /s /q node_modules
del package-lock.json

# 2. 清理 npm 缓存
npm cache clean --force

# 3. 重新安装依赖
npm install

# 4. 生成 Prisma 客户端
npx prisma generate

# 5. 构建
npx next build
```

或者直接运行准备好的脚本：
```bash
reinstall-and-build.bat
```

### 方案 2: 快速修复（如果方案1太慢）

```bash
# 只重新安装 Next.js 相关包
npm install next react react-dom --force
npx next build
```

## 预期结果

修复后，构建应该能够成功完成，输出类似：
```
✓ Compiled successfully
✓ Linting and checking validity of types
✓ Collecting page data
✓ Generating static pages (X/X)
✓ Collecting build traces
✓ Finalizing page optimization

Route (app)                              Size     First Load JS
┌ ○ /                                    XXX kB         XXX kB
├ ○ /api/...                             ...
...
```

## 验证步骤

1. 构建成功后，检查 `.next` 目录是否存在
2. 运行 `npm start` 启动生产服务器
3. 访问 `http://localhost:3000` 验证应用正常运行

## 创建的辅助脚本

- `fix-build-error.js` - 清理和配置修复
- `fix-prerender-error.js` - 修复预渲染问题
- `reinstall-and-build.bat` - 完整重装和构建
- `fix-next.bat` - 快速修复 Next.js
- `simple-build.bat` - 简单构建脚本

## 注意事项

- 重新安装依赖可能需要 5-10 分钟
- 确保网络连接稳定
- 如果使用 npm 镜像，确保镜像源可用
- 构建过程中可能会有 TypeScript 警告，但已配置忽略

## 下一步

修复完成后，可以：
1. 部署到 Vercel 或其他平台
2. 运行完整的功能测试
3. 检查所有 API 端点是否正常工作
